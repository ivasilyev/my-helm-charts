apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Chart.Name }}-configmap
data:
  script-1.sh: |
    #!/usr/bin/bash
    set -m ;

    cat <<EOF | tee "/tmp/reset.sql"
    FLUSH PRIVILEGES ;
    ALTER USER 'root'@'localhost' IDENTIFIED BY 'password' ;
    GRANT ALL PRIVILEGES ON *.* TO 'root'@'localhost' WITH GRANT OPTION ;
    EOF

    rm -rf /var/lib/mysql/* ;
    mysqld --initialize --init-file=/tmp/reset.sql ;
    echo "Database initialized" ;

    mysqld --port=3306 &
    export MYSQL_PID=$!
    echo "Started MySQL server, PID ${MYSQL_PID}"

    sleep 5;
    curl -fsSL \
        -o "/tmp/db.sql" \
        "https://raw.githubusercontent.com/lerocha/chinook-database/master/ChinookDatabase/DataSources/Chinook_MySql.sql" ;
    echo "Population script downloaded" ;

    mysql --port=3306 --user=root --password=password < /tmp/db.sql ;
    echo "Database populated" ;

    rm -rf /tmp/* ;
    echo "Cleanup completed" ;

    fg %1 ;
